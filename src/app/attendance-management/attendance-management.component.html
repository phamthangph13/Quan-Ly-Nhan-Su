<div class="attendance-container">
  <div class="sidebar">
    <div class="logo">
      <h2>Hệ Thống HR</h2>
    </div>
    <nav>
      <ul>
        <li><a href="/dashboard">Trang Chủ</a></li>
        <li><a href="/employee-list">Nhân Viên</a></li>
        <li><a href="/salary-management">Quản Lý Lương</a></li>
        <li><a href="/leave-management">Quản Lý Nghỉ Phép</a></li>
        <li><a href="/attendance-management" class="active">Quản Lý Chấm Công</a></li>
        <li><a href="/hr-settings">Cài Đặt</a></li>
      </ul>
    </nav>
  </div>
  
  <div class="main-content">
    <div class="header">
      <h1>Quản Lý Chấm Công</h1>
      <div class="date-picker">
        <button class="date-nav-btn" (click)="changeMonth(-1)">«</button>
        <div class="current-date">{{ currentMonthText }}</div>
        <button class="date-nav-btn" (click)="changeMonth(1)">»</button>
      </div>
    </div>
    
    <div class="filter-section">
      <div class="filter-group">
        <label>Phòng ban:</label>
        <select [(ngModel)]="selectedDepartment" (change)="onDepartmentChange()">
          <option value="all">Tất cả</option>
          <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
        </select>
      </div>
      
      <div class="search-bar">
        <input type="text" placeholder="Tìm kiếm nhân viên..." [(ngModel)]="searchTerm">
        <button (click)="onSearch()">Tìm Kiếm</button>
      </div>
      
      <div class="action-buttons">
        <button class="add-btn" (click)="openAttendanceForm()">
          <i class="fas fa-plus"></i> Thêm Mới
        </button>
        <button class="report-btn" (click)="generateReport()">
          <i class="fas fa-file-export"></i> Xuất Báo Cáo
        </button>
      </div>
    </div>
    
    <div class="loading-indicator" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>
    
    <div class="attendance-table" *ngIf="!isLoading">
      <table>
        <thead>
          <tr>
            <th>Nhân Viên</th>
            <th>Phòng Ban</th>
            <th>Làm Việc</th>
            <th>Nghỉ Phép</th>
            <th>Vắng</th>
            <th>Đi Trễ</th>
            <th>Về Sớm</th>
            <th>Tỷ Lệ Chuyên Cần</th>
            <th>Thao Tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of filteredAttendance">
            <td>{{ record.employeeName }}</td>
            <td>{{ record.department }}</td>
            <td>{{ record.presentDays }}</td>
            <td>{{ record.leaveDaysRemaining }}</td>
            <td>{{ record.absentDays }}</td>
            <td>{{ record.lateDays }}</td>
            <td>{{ record.earlyDepartures }}</td>
            <td>
              <div class="attendance-rate">
                <div class="progress-bar" [style.width.%]="record.attendanceRate"></div>
                <span>{{ record.attendanceRate }}%</span>
              </div>
            </td>
            <td>
              <button class="action-btn view" (click)="viewEmployeeDetails(record.employeeId)">Chi Tiết</button>
              <button class="action-btn edit" (click)="editAttendanceRecord(record)">Chỉnh Sửa</button>
            </td>
          </tr>
          <tr *ngIf="filteredAttendance.length === 0">
            <td colspan="9" class="no-data">Không có dữ liệu chấm công</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="summary-section" *ngIf="!isLoading">
      <div class="summary-card">
        <h3>Tỷ Lệ Chuyên Cần</h3>
        <div class="summary-value">{{ avgAttendanceRate }}%</div>
      </div>
      
      <div class="summary-card">
        <h3>Nhân Viên Chuyên Cần Nhất</h3>
        <div class="summary-value">{{ bestAttendanceEmployee }}</div>
      </div>
      
      <div class="summary-card">
        <h3>Nhân Viên Hay Đi Trễ Nhất</h3>
        <div class="summary-value">{{ mostLateEmployee }}</div>
      </div>
    </div>
    
    <div class="calendar-view" *ngIf="selectedEmployee !== null">
      <div class="calendar-header-bar">
        <h2>Lịch Chấm Công</h2>
        <div class="employee-info">
          <span>Nhân viên: {{ getSelectedEmployeeName() }}</span>
          <button class="close-btn" (click)="closeEmployeeDetails()">×</button>
        </div>
      </div>
      
      <div class="calendar-header">
        <div class="weekday">CN</div>
        <div class="weekday">T2</div>
        <div class="weekday">T3</div>
        <div class="weekday">T4</div>
        <div class="weekday">T5</div>
        <div class="weekday">T6</div>
        <div class="weekday">T7</div>
      </div>
      
      <div class="calendar-grid">
        <div *ngFor="let day of calendarDays" 
             class="calendar-day" 
             [ngClass]="{
               'weekend': day.isWeekend, 
               'current-day': day.isCurrentDay, 
               'inactive': !day.isCurrentMonth,
               'present': day.attendance?.statusClass === 'present',
               'absent': day.attendance?.statusClass === 'absent',
               'late': day.attendance?.statusClass === 'late',
               'early': day.attendance?.statusClass === 'early',
               'leave': day.attendance?.statusClass === 'leave',
               'half-day': day.attendance?.statusClass === 'half-day'
             }">
          <div class="day-number">{{ day.date }}</div>
          <div class="day-info" *ngIf="day.info">{{ day.info }}</div>
          <div class="attendance-info" *ngIf="day.attendance">
            <div class="status">{{ day.attendance.statusText }}</div>
            <div class="time" *ngIf="day.attendance.checkIn">Vào: {{ day.attendance.checkIn }}</div>
            <div class="time" *ngIf="day.attendance.checkOut">Ra: {{ day.attendance.checkOut }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Attendance Form Modal -->
<div class="modal" *ngIf="showAttendanceForm">
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ isEditingRecord ? 'Chỉnh Sửa Dữ Liệu Chấm Công' : 'Thêm Dữ Liệu Chấm Công' }}</h2>
      <button class="close-btn" (click)="closeAttendanceForm()">×</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="submitAttendanceRecord()">
        <div class="form-group">
          <label for="employeeId">Nhân Viên:</label>
          <select id="employeeId" [(ngModel)]="newAttendanceRecord.employeeId" name="employeeId" required>
            <option value="">-- Chọn Nhân Viên --</option>
            <option *ngFor="let employee of employees" [value]="employee.id">
              {{ employee.lastName }} {{ employee.firstName }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="date">Ngày:</label>
          <input type="date" id="date" [(ngModel)]="newAttendanceRecord.date" name="date" required>
        </div>
        
        <div class="form-row">
          <div class="form-group half">
            <label for="checkInTime">Giờ Vào:</label>
            <input type="time" id="checkInTime" [(ngModel)]="newAttendanceRecord.checkInTime" name="checkInTime" required>
          </div>
          
          <div class="form-group half">
            <label for="checkInStatus">Trạng Thái Vào:</label>
            <select id="checkInStatus" [(ngModel)]="newAttendanceRecord.checkInStatus" name="checkInStatus">
              <option value="on-time">Đúng giờ</option>
              <option value="late">Đi muộn</option>
              <option value="leave">Nghỉ phép</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group half">
            <label for="checkOutTime">Giờ Ra:</label>
            <input type="time" id="checkOutTime" [(ngModel)]="newAttendanceRecord.checkOutTime" name="checkOutTime" required>
          </div>
          
          <div class="form-group half">
            <label for="checkOutStatus">Trạng Thái Ra:</label>
            <select id="checkOutStatus" [(ngModel)]="newAttendanceRecord.checkOutStatus" name="checkOutStatus">
              <option value="on-time">Đúng giờ</option>
              <option value="early">Về sớm</option>
              <option value="leave">Nghỉ phép</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="status">Trạng Thái Chung:</label>
          <select id="status" [(ngModel)]="newAttendanceRecord.status" name="status" required>
            <option value="present">Có mặt</option>
            <option value="absent">Vắng mặt</option>
            <option value="half-day">Nửa ngày</option>
            <option value="leave">Nghỉ phép</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="notes">Ghi Chú:</label>
          <textarea id="notes" [(ngModel)]="newAttendanceRecord.notes" name="notes" rows="3"></textarea>
        </div>
        
        <div class="form-buttons">
          <button type="button" class="cancel-btn" (click)="closeAttendanceForm()">Hủy</button>
          <button type="submit" class="submit-btn" [disabled]="isLoading">
            <span *ngIf="!isLoading">{{ isEditingRecord ? 'Cập Nhật' : 'Lưu' }}</span>
            <span *ngIf="isLoading">{{ isEditingRecord ? 'Đang cập nhật...' : 'Đang lưu...' }}</span>
          </button>
          <button type="button" class="debug-btn" (click)="toggleDebugMode()">
            {{ isDebugMode ? 'Ẩn thông tin gỡ lỗi' : 'Hiện thông tin gỡ lỗi' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hiển thị thông tin debug nếu cần -->
<div *ngIf="isDebugMode" class="debug-info">
  <h4>Thông tin gỡ lỗi:</h4>
  <pre>{{ newAttendanceRecord | json }}</pre>
  <button type="button" (click)="isDebugMode = false">Ẩn thông tin gỡ lỗi</button>
</div>
